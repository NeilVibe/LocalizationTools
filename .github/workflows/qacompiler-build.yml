# QA Compiler Suite - Build Workflow
# Separate from main LocaNext build - triggered independently
#
# This workflow:
# 1. Runs on changes to QACompilerNEW folder OR manual trigger OR QACOMPILER_BUILD.txt
# 2. Builds standalone Windows executable with PyInstaller
# 3. Creates Inno Setup installer with drive selection
# 4. Uploads to GitHub Releases
#
# SINGLE JOB - No fragmented runs

name: QA Compiler Build

on:
  push:
    branches: [main]
    paths:
      - 'QACOMPILER_BUILD.txt'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.1)'
        required: false
        default: ''

permissions:
  contents: write

env:
  QACOMPILER_PATH: RessourcesForCodingTheProject/NewScripts/QACompilerNEW

jobs:
  build-and-release:
    name: Build & Release QA Compiler
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history for diff

      - name: Check build trigger and generate version
        id: check
        shell: pwsh
        run: |
          # ============================================================
          # VERSION FORMAT: YY.MMDD.HHMM (same as LocaNext - semver-compatible)
          # ============================================================

          $shouldBuild = $false

          # Check if QACOMPILER_BUILD.txt was modified
          $diffOutput = git diff --name-only HEAD~1 HEAD 2>$null
          if ($diffOutput -match "QACOMPILER_BUILD.txt") {
            $trigger = Get-Content QACOMPILER_BUILD.txt | Select-String -Pattern "^Build" | Select-Object -Last 1
            if ($trigger) {
              $shouldBuild = $true
              Write-Host "Trigger: $trigger"
            }
          } elseif ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $shouldBuild = $true
            Write-Host "Manual trigger via workflow_dispatch"
          } elseif ($diffOutput -match "QACompilerNEW") {
            $shouldBuild = $true
            Write-Host "QACompilerNEW files changed"
          }

          if (-not $shouldBuild) {
            Write-Host "No QACompiler changes detected - skipping build"
            echo "should_build=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          echo "should_build=true" >> $env:GITHUB_OUTPUT

          # AUTO-GENERATE VERSION: YY.MMDD.HHMM format (Korean time)
          $version = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId([DateTime]::UtcNow, 'Korea Standard Time').ToString("yy.Mdd.HHmm")
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "[OK] Auto-generated version: $version (YY.MMDD.HHMM format)"

      - name: Setup Python 3.10
        if: steps.check.outputs.should_build == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          cd ${{ env.QACOMPILER_PATH }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Inject Version
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          $version = "${{ steps.check.outputs.version }}"
          $qaPath = "${{ env.QACOMPILER_PATH }}"

          Write-Host "=== VERSION INJECTION ==="
          Write-Host "Version: $version"

          # Update installer script version
          $issPath = "$qaPath\installer\QACompiler.iss"
          if (Test-Path $issPath) {
            (Get-Content $issPath) -replace '#define MyAppVersion "[^"]*"', "#define MyAppVersion `"$version`"" | Set-Content $issPath
            Write-Host "[OK] Updated: $issPath"
          }

          # Update config.py with version
          $configPath = "$qaPath\config.py"
          if (Test-Path $configPath) {
            $content = Get-Content $configPath -Raw
            if ($content -match 'VERSION\s*=') {
              $content = $content -replace 'VERSION\s*=\s*"[^"]*"', "VERSION = `"$version`""
            } else {
              $content = "VERSION = `"$version`"`n" + $content
            }
            Set-Content $configPath $content
            Write-Host "[OK] Updated: $configPath"
          }

      - name: Build executable with PyInstaller
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          cd ${{ env.QACOMPILER_PATH }}
          pyinstaller QACompiler.spec --clean --noconfirm

      - name: Verify build
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          $exePath = "${{ env.QACOMPILER_PATH }}\dist\QACompiler\QACompiler.exe"
          if (!(Test-Path $exePath)) {
            Write-Error "Build failed - QACompiler.exe not found"
            exit 1
          }
          $size = (Get-Item $exePath).length / 1MB
          Write-Host "Build successful! Size: $([math]::Round($size, 1)) MB"

      - name: Create working folders
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          $distPath = "${{ env.QACOMPILER_PATH }}\dist\QACompiler"

          $folders = @(
            "QAfolder", "QAfolderOLD", "QAfolderNEW", "GeneratedDatasheets",
            "Masterfolder_EN", "Masterfolder_EN\Images",
            "Masterfolder_CN", "Masterfolder_CN\Images"
          )

          foreach ($folder in $folders) {
            $path = "$distPath\$folder"
            New-Item -ItemType Directory -Path $path -Force | Out-Null
            # Add .gitkeep for empty folder preservation
            New-Item -ItemType File -Path "$path\.gitkeep" -Force | Out-Null
          }

          # Copy config files
          Copy-Item "${{ env.QACOMPILER_PATH }}\languageTOtester_list.example.txt" "$distPath\" -ErrorAction SilentlyContinue
          Copy-Item "${{ env.QACOMPILER_PATH }}\TesterType.example.txt" "$distPath\" -ErrorAction SilentlyContinue

          Write-Host "Working folders created"

      - name: Install Inno Setup
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: choco install innosetup -y

      - name: Compile installer
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          $issPath = "${{ env.QACOMPILER_PATH }}\installer\QACompiler.iss"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" $issPath

      - name: Create portable ZIP
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          $version = "${{ steps.check.outputs.version }}"
          $distPath = "${{ env.QACOMPILER_PATH }}\dist\QACompiler"
          $zipPath = "${{ env.QACOMPILER_PATH }}\installer_output\QACompiler_v${version}_Portable.zip"

          Compress-Archive -Path "$distPath\*" -DestinationPath $zipPath -Force
          $size = (Get-Item $zipPath).Length / 1MB
          Write-Host "Portable ZIP: $([math]::Round($size, 1)) MB"

      - name: Create source code ZIP
        if: steps.check.outputs.should_build == 'true'
        shell: pwsh
        run: |
          $version = "${{ steps.check.outputs.version }}"
          $sourcePath = "${{ env.QACOMPILER_PATH }}"
          $zipPath = "${{ env.QACOMPILER_PATH }}\installer_output\QACompiler_v${version}_Source.zip"

          $tempDir = New-Item -ItemType Directory -Path "$env:TEMP\QACompiler_Source" -Force
          $excludes = @("dist", "build", "__pycache__", "*.pyc", "installer_output", ".pytest_cache")

          Get-ChildItem -Path $sourcePath -Exclude $excludes | Copy-Item -Destination $tempDir -Recurse -Force
          Get-ChildItem -Path $tempDir -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath -Force
          Remove-Item -Path $tempDir -Recurse -Force

          $size = (Get-Item $zipPath).Length / 1MB
          Write-Host "Source ZIP: $([math]::Round($size, 1)) MB"

      - name: Upload Setup
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: QACompiler-Setup
          path: ${{ env.QACOMPILER_PATH }}/installer_output/*.exe
          retention-days: 30

      - name: Upload Portable
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: QACompiler-Portable
          path: ${{ env.QACOMPILER_PATH }}/installer_output/*_Portable.zip
          retention-days: 30

      - name: Upload Source
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: QACompiler-Source
          path: ${{ env.QACOMPILER_PATH }}/installer_output/*_Source.zip
          retention-days: 30

      - name: Create GitHub Release
        if: steps.check.outputs.should_build == 'true' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qacompiler-v${{ steps.check.outputs.version }}
          name: QA Compiler Suite v${{ steps.check.outputs.version }}
          body: |
            # QA Compiler Suite v${{ steps.check.outputs.version }}

            ## Download

            - **QACompiler_v${{ steps.check.outputs.version }}_Setup.exe** - Installer (recommended)
            - **QACompiler_v${{ steps.check.outputs.version }}_Portable.zip** - Portable ZIP (no install)
            - **QACompiler_v${{ steps.check.outputs.version }}_Source.zip** - Source code

            ## Features

            - Generate datasheets for all categories
            - Transfer QA files with automatic merging
            - Build master files with issue tracking
            - Coverage analysis and word count reports
            - Portable installation (Desktop by default)
            - Drive selection for Perforce path

            ---
            *Portable installation - no admin rights required*
          draft: false
          prerelease: false
          files: |
            ${{ env.QACOMPILER_PATH }}/installer_output/*.exe
            ${{ env.QACOMPILER_PATH }}/installer_output/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "=== QA Compiler Build Complete ==="
          echo "Version: ${{ steps.check.outputs.version }}"
          echo "Release: qacompiler-v${{ steps.check.outputs.version }}"
