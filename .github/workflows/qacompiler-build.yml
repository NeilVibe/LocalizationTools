# QA Compiler Suite - Build Workflow
# Separate from main LocaNext build - triggered independently
#
# This workflow:
# 1. Runs on changes to QACompilerNEW folder OR manual trigger OR QACOMPILER_BUILD.txt
# 2. Builds standalone Windows executable with PyInstaller
# 3. Creates Inno Setup installer with drive selection
# 4. Uploads to GitHub Releases
#
# NO CONFLICT with main LocaNext build - completely independent

name: QA Compiler Build

on:
  push:
    branches: [main]
    paths:
      - 'RessourcesForCodingTheProject/NewScripts/QACompilerNEW/**'
      - 'QACOMPILER_BUILD.txt'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.1)'
        required: false
        default: ''

permissions:
  contents: write

env:
  QACOMPILER_PATH: RessourcesForCodingTheProject/NewScripts/QACompilerNEW

jobs:
  check-trigger:
    name: Check Build Trigger
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check build trigger
        id: check
        run: |
          # ============================================================
          # VERSION FORMAT: YY.MMDD.HHMM (same as LocaNext - semver-compatible)
          # Build number in trigger file is just for tracking
          # ============================================================

          # Check if QACOMPILER_BUILD.txt was modified
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "QACOMPILER_BUILD.txt"; then
            TRIGGER=$(cat QACOMPILER_BUILD.txt 2>/dev/null | grep -E "^Build" | tail -1 || echo "")
            if [ -n "$TRIGGER" ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "Trigger: $TRIGGER"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "No valid build trigger"
            fi
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Manual trigger via workflow_dispatch"
          else
            # Check if QACompilerNEW files changed
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "QACompilerNEW"; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "QACompilerNEW files changed"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "No QACompiler changes detected"
            fi
          fi

          # AUTO-GENERATE VERSION: YY.MMDD.HHMM format (semver-compatible, Korean time)
          # Same format as LocaNext for consistency
          VERSION=$(TZ='Asia/Seoul' date '+%y.%-m%d.%H%M')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "[OK] Auto-generated version: $VERSION (YY.MMDD.HHMM format)"

  build-installer:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd ${{ env.QACOMPILER_PATH }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        shell: pwsh

      - name: Inject Version (Pipeline Executive Power)
        run: |
          $version = "${{ needs.check-trigger.outputs.version }}"
          $qaPath = "${{ env.QACOMPILER_PATH }}"

          Write-Host "=== PIPELINE EXECUTIVE POWER ==="
          Write-Host "Injecting version: $version (YY.MMDD.HHMM format)"

          # Update installer script version
          $issPath = "$qaPath\installer\QACompiler.iss"
          if (Test-Path $issPath) {
            (Get-Content $issPath) -replace '#define MyAppVersion "[^"]*"', "#define MyAppVersion `"$version`"" | Set-Content $issPath
            Write-Host "[OK] Updated: $issPath"
          }

          # Update config.py with version
          $configPath = "$qaPath\config.py"
          if (Test-Path $configPath) {
            $content = Get-Content $configPath -Raw
            if ($content -match 'VERSION\s*=') {
              $content = $content -replace 'VERSION\s*=\s*"[^"]*"', "VERSION = `"$version`""
            } else {
              # Add VERSION if not present
              $content = "VERSION = `"$version`"`n" + $content
            }
            Set-Content $configPath $content
            Write-Host "[OK] Updated: $configPath"
          }

          Write-Host "[OK] Version injection complete"
        shell: pwsh

      - name: Build executable with PyInstaller
        run: |
          cd ${{ env.QACOMPILER_PATH }}
          pyinstaller QACompiler.spec --clean --noconfirm
        shell: pwsh

      - name: Verify build
        run: |
          $exePath = "${{ env.QACOMPILER_PATH }}\dist\QACompiler\QACompiler.exe"
          if (!(Test-Path $exePath)) {
            Write-Error "Build failed - QACompiler.exe not found at: $exePath"
            Get-ChildItem "${{ env.QACOMPILER_PATH }}\dist" -Recurse | Select-Object -First 20
            exit 1
          }
          Write-Host "Build successful!"
          $size = (Get-Item $exePath).length / 1MB
          Write-Host "  Executable size: $([math]::Round($size, 1)) MB"
        shell: pwsh

      - name: Create working folders in dist
        run: |
          $distPath = "${{ env.QACOMPILER_PATH }}\dist\QACompiler"

          # Create all required folders
          $folders = @(
            "QAfolder",
            "QAfolderOLD",
            "QAfolderNEW",
            "GeneratedDatasheets",
            "Masterfolder_EN",
            "Masterfolder_EN\Images",
            "Masterfolder_CN",
            "Masterfolder_CN\Images"
          )

          foreach ($folder in $folders) {
            $path = "$distPath\$folder"
            if (!(Test-Path $path)) {
              New-Item -ItemType Directory -Path $path -Force | Out-Null
              Write-Host "Created: $folder"
            }
          }

          # Copy config files
          Copy-Item "${{ env.QACOMPILER_PATH }}\languageTOtester_list.example.txt" "$distPath\" -ErrorAction SilentlyContinue
          if (Test-Path "${{ env.QACOMPILER_PATH }}\languageTOtester_list.txt") {
            Copy-Item "${{ env.QACOMPILER_PATH }}\languageTOtester_list.txt" "$distPath\"
          }

          # Copy TesterType config files
          Copy-Item "${{ env.QACOMPILER_PATH }}\TesterType.example.txt" "$distPath\" -ErrorAction SilentlyContinue
          if (Test-Path "${{ env.QACOMPILER_PATH }}\TesterType.txt") {
            Copy-Item "${{ env.QACOMPILER_PATH }}\TesterType.txt" "$distPath\"
          }
        shell: pwsh

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: pwsh

      - name: Compile installer
        run: |
          $issPath = "${{ env.QACOMPILER_PATH }}\installer\QACompiler.iss"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" $issPath
        shell: pwsh

      - name: Verify installer
        run: |
          $version = "${{ needs.check-trigger.outputs.version }}"
          $outputDir = "${{ env.QACOMPILER_PATH }}\installer_output"

          Write-Host "Looking for installer in: $outputDir"

          if (!(Test-Path $outputDir)) {
            Write-Error "Installer output directory not found!"
            exit 1
          }

          $installer = Get-ChildItem "$outputDir\*.exe" | Select-Object -First 1
          if (!$installer) {
            Write-Error "No installer .exe found!"
            exit 1
          }

          Write-Host "Installer compiled successfully!"
          Write-Host "  File: $($installer.Name)"
          $size = $installer.Length / 1MB
          Write-Host "  Size: $([math]::Round($size, 1)) MB"
        shell: pwsh

      - name: Create portable ZIP
        run: |
          $version = "${{ needs.check-trigger.outputs.version }}"
          $distPath = "${{ env.QACOMPILER_PATH }}\dist\QACompiler"
          $zipPath = "${{ env.QACOMPILER_PATH }}\installer_output\QACompiler_v${version}_Portable.zip"

          Write-Host "Creating portable ZIP..."
          Compress-Archive -Path "$distPath\*" -DestinationPath $zipPath -Force

          $size = (Get-Item $zipPath).Length / 1MB
          Write-Host "Portable ZIP created: $([math]::Round($size, 1)) MB"
        shell: pwsh

      - name: Create source code ZIP
        run: |
          $version = "${{ needs.check-trigger.outputs.version }}"
          $sourcePath = "${{ env.QACOMPILER_PATH }}"
          $zipPath = "${{ env.QACOMPILER_PATH }}\installer_output\QACompiler_v${version}_Source.zip"

          Write-Host "Creating source code ZIP..."
          # Exclude build artifacts, cache, etc.
          $excludes = @("dist", "build", "__pycache__", "*.pyc", "installer_output", ".pytest_cache")

          # Create temp folder with clean source
          $tempDir = New-Item -ItemType Directory -Path "$env:TEMP\QACompiler_Source" -Force

          # Copy source files excluding build artifacts
          Get-ChildItem -Path $sourcePath -Exclude $excludes | Copy-Item -Destination $tempDir -Recurse -Force

          # Remove any __pycache__ folders that got copied
          Get-ChildItem -Path $tempDir -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # Create ZIP
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath -Force

          # Cleanup
          Remove-Item -Path $tempDir -Recurse -Force

          $size = (Get-Item $zipPath).Length / 1MB
          Write-Host "Source ZIP created: $([math]::Round($size, 1)) MB"
        shell: pwsh

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: QACompiler_Setup
          path: ${{ env.QACOMPILER_PATH }}/installer_output/*.exe
          retention-days: 30

      - name: Upload portable ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: QACompiler_Portable
          path: ${{ env.QACOMPILER_PATH }}/installer_output/*_Portable.zip
          retention-days: 30

      - name: Upload source ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: QACompiler_Source
          path: ${{ env.QACOMPILER_PATH }}/installer_output/*_Source.zip
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-trigger, build-installer]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: QACompiler_Setup
          path: ./artifacts

      - name: Download portable ZIP
        uses: actions/download-artifact@v4
        with:
          name: QACompiler_Portable
          path: ./artifacts

      - name: Download source ZIP
        uses: actions/download-artifact@v4
        with:
          name: QACompiler_Source
          path: ./artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lh artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qacompiler-v${{ needs.check-trigger.outputs.version }}
          name: QA Compiler Suite v${{ needs.check-trigger.outputs.version }}
          body: |
            # QA Compiler Suite v${{ needs.check-trigger.outputs.version }}

            ## Download

            - **QACompiler_v${{ needs.check-trigger.outputs.version }}_Setup.exe** - Installer (recommended)
            - **QACompiler_v${{ needs.check-trigger.outputs.version }}_Portable.zip** - Portable ZIP (no install needed)
            - **QACompiler_v${{ needs.check-trigger.outputs.version }}_Source.zip** - Source code

            ## Features

            - Generate datasheets for all categories (Quest, Knowledge, Item, Region, Skill, Help, Character, Gimmick)
            - Transfer QA files with automatic merging
            - Build master files with issue tracking
            - Coverage analysis and word count reports
            - Portable installation (Desktop by default)
            - Drive selection for Perforce path (F:, D:, E:, etc.)
            - No Python required - fully standalone

            ## Installation

            1. Download the installer
            2. Run the setup
            3. Select your Perforce drive (F: is default)
            4. Choose install location (Desktop recommended)
            5. Launch QA Compiler Suite

            ## Workflows

            **Daily:** Download from Redmine -> Put in QAfolder -> Done!

            **Weekly:**
            1. Move QAfolder contents to QAfolderOLD
            2. Generate fresh datasheets
            3. Click Transfer (auto-populates QAfolderNEW)
            4. Build master files

            ---
            *Portable installation - no admin rights required*
          draft: false
          prerelease: false
          files: |
            artifacts/*.exe
            artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "Release v${{ needs.check-trigger.outputs.version }} created successfully!"
          echo ""
          echo "Download: QACompiler_v${{ needs.check-trigger.outputs.version }}_Setup.exe"
