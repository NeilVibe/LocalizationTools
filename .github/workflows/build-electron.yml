name: Build LocaNext LIGHT Installer

# LIGHT Build Strategy (2025-11-30)
# - NO model bundled in build (saves LFS bandwidth)
# - Model downloaded by user post-install via Hugging Face
# - Build size: ~100-150MB instead of ~2GB

on:
  push:
    branches: [ main ]
    paths:
      - 'BUILD_TRIGGER.txt'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-build-trigger:
    name: Check Build Trigger
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # NO lfs: true - LIGHT build doesn't need the model!

      - name: Check BUILD_TRIGGER.txt
        id: check
        run: |
          TRIGGER=$(cat BUILD_TRIGGER.txt | grep -E "Build (LIGHT|FULL)" | tail -1)
          echo "Trigger line: $TRIGGER"

          if echo "$TRIGGER" | grep -qE "Build (LIGHT|FULL)"; then
            echo "should_build=true" >> $GITHUB_OUTPUT

            # Extract version
            VERSION=$(echo "$TRIGGER" | grep -oE 'v[0-9]+' | sed 's/v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "‚úì Build triggered for version: $VERSION"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No build trigger found"
          fi

  # ============================================================
  # SAFETY CHECKS - Must pass before build proceeds
  # ============================================================
  safety-checks:
    name: Safety Checks (Tests, Security, Version)
    runs-on: ubuntu-latest
    needs: check-build-trigger
    if: needs.check-build-trigger.outputs.should_build == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: locaNext/package-lock.json

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pip-audit

      - name: Install Node Dependencies
        run: |
          cd locaNext && npm ci

      # ---- VERSION CHECK ----
      - name: Version Unification Check
        run: |
          echo "=== Checking version unification across all files ==="
          python scripts/check_version_unified.py
          echo "‚úì All versions unified"

      # ---- PYTHON TESTS ----
      - name: Run Python Tests
        run: |
          echo "=== Running Python test suite ==="
          python -m pytest tests/ -v --tb=short --ignore=tests/archive/ -x
          echo "‚úì All Python tests passed"

      # ---- SECURITY AUDITS ----
      - name: Python Security Audit
        run: |
          echo "=== Checking Python dependencies for vulnerabilities ==="
          pip-audit --strict --desc || echo "‚ö†Ô∏è Some vulnerabilities found (non-blocking)"
        continue-on-error: true  # Don't fail build, just warn

      - name: NPM Security Audit
        run: |
          echo "=== Checking NPM dependencies for vulnerabilities ==="
          cd locaNext && npm audit --audit-level=high || echo "‚ö†Ô∏è Some vulnerabilities found (non-blocking)"
        continue-on-error: true  # Don't fail build, just warn

      - name: Safety Checks Summary
        run: |
          echo "============================================"
          echo "‚úÖ SAFETY CHECKS PASSED"
          echo "============================================"
          echo "- Version unification: ‚úì"
          echo "- Python tests: ‚úì"
          echo "- Security audits: Completed (warnings only)"
          echo "============================================"
          echo "Proceeding to build..."

  build-windows:
    name: Build Windows LIGHT Installer
    runs-on: windows-latest
    needs: [check-build-trigger, safety-checks]  # Must pass safety checks first!
    if: needs.check-build-trigger.outputs.should_build == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # NO lfs: true - LIGHT build, model downloaded by user post-install

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: locaNext/package-lock.json

      - name: Install Dependencies
        run: |
          cd locaNext
          npm ci
        shell: pwsh

      - name: Build Electron App
        run: |
          cd locaNext
          npm run build
          npm run build:electron
        shell: pwsh

      - name: Verify Electron Build
        run: |
          Write-Host "Verifying Electron build output..."

          if (!(Test-Path "locaNext\dist-electron\win-unpacked\LocaNext.exe")) {
            Write-Error "‚ùå Electron build failed - LocaNext.exe not found"
            exit 1
          }

          Write-Host "‚úì Electron build successful"
          $size = (Get-Item "locaNext\dist-electron\win-unpacked\LocaNext.exe").length / 1MB
          Write-Host "  Executable size: $([math]::Round($size, 1)) MB"

          $totalSize = (Get-ChildItem "locaNext\dist-electron\win-unpacked" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "  Total app size: $([math]::Round($totalSize, 1)) MB (LIGHT - no model)"
        shell: pwsh

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: pwsh

      - name: Compile LIGHT Installer
        run: |
          Write-Host "Compiling LIGHT Windows installer..."
          Write-Host "Note: Model NOT bundled - will be downloaded post-install"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\locanext_light.iss
        shell: pwsh

      - name: Verify Installer
        run: |
          $version = "${{ needs.check-build-trigger.outputs.version }}"
          $installerPath = "installer_output\LocaNext_v${version}_Light_Setup.exe"

          Write-Host "Looking for LIGHT installer at: $installerPath"

          # Try with version, then try to find any installer
          if (!(Test-Path $installerPath)) {
            Write-Host "Exact path not found, searching for any installer..."
            $found = Get-ChildItem "installer_output\*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              Write-Host "Found installer: $($found.Name)"
              $installerPath = $found.FullName
            } else {
              Write-Error "‚ùå No installer found in installer_output"
              exit 1
            }
          }

          Write-Host "‚úì LIGHT Installer compiled successfully"
          $size = (Get-Item $installerPath).length / 1MB
          Write-Host "  Installer size: $([math]::Round($size, 1)) MB"
          Write-Host "  (Model will be downloaded post-install: ~447MB)"
        shell: pwsh

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LocaNext-Windows-LIGHT-Setup
          path: installer_output/*.exe
          retention-days: 7

  build-linux:
    name: Build Linux AppImage (LIGHT)
    runs-on: ubuntu-latest
    needs: [check-build-trigger, safety-checks]  # Must pass safety checks first!
    if: needs.check-build-trigger.outputs.should_build == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # NO lfs: true - LIGHT build

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: locaNext/package-lock.json

      - name: Install Dependencies
        run: |
          cd locaNext
          npm ci

      - name: Build Electron App (Linux)
        run: |
          cd locaNext
          npm run build
          npm run build:electron

      - name: Verify Linux Build
        run: |
          echo "Verifying Linux build output..."
          find locaNext/dist-electron -name "*.AppImage" -type f 2>/dev/null || true

          if ls locaNext/dist-electron/*.AppImage 1> /dev/null 2>&1; then
            echo "‚úì AppImage found"
            ls -lh locaNext/dist-electron/*.AppImage
          else
            echo "Note: AppImage may not be built (depends on electron-builder config)"
          fi

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LocaNext-Linux-LIGHT-AppImage
          path: locaNext/dist-electron/*.AppImage
          retention-days: 7
        continue-on-error: true

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-build-trigger, build-windows, build-linux]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: LocaNext-Windows-LIGHT-Setup
          path: artifacts/windows

      - name: Download Linux AppImage
        uses: actions/download-artifact@v4
        with:
          name: LocaNext-Linux-LIGHT-AppImage
          path: artifacts/linux
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-build-trigger.outputs.version }}
          name: LocaNext v${{ needs.check-build-trigger.outputs.version }} (LIGHT)
          draft: false
          prerelease: false
          body: |
            ## LocaNext Desktop Application (LIGHT Build)

            **Version:** ${{ needs.check-build-trigger.outputs.version }}
            **Build Type:** LIGHT (model downloaded during installation)

            ### üì• Downloads

            **Windows:**
            - `LocaNext_v${{ needs.check-build-trigger.outputs.version }}_Light_Setup.exe` (~100-150MB)
            - AI model (~447MB) downloads automatically during installation

            **Linux:**
            - `LocaNext.AppImage` (~100-150MB, if available)
            - Run `scripts/download_model.bat` after to get AI features

            ### ‚ö†Ô∏è Requirements

            - **Python 3.10+** - Required for AI model download
            - **Internet connection** - For post-install model download
            - **~1GB disk space** - For app + model

            ### üöÄ What's Included

            - ‚úÖ **XLSTransfer** - AI-powered Excel translation
            - ‚úÖ **QuickSearch** - Multi-game dictionary (BDO, BDM, BDC, CD)
            - ‚úÖ **Admin Dashboard** - Usage analytics
            - ‚è≥ **Korean BERT Model** - Downloaded during installation

            ### üíª Installation

            **Windows:**
            1. Download the installer
            2. Run the installer
            3. Wait for AI model download (~5-10 min)
            4. Launch LocaNext!

            **If model download fails:**
            - Run `scripts\download_model.bat` manually
            - Or copy `models\kr-sbert\` from another installation

            ### üîê Default Credentials

            - Username: `admin`
            - Password: `admin123`

            **‚ö†Ô∏è Change these for production use!**

            ---

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
          files: |
            artifacts/windows/*.exe
            artifacts/linux/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
