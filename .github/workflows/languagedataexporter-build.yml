name: LanguageDataExporter Build & Release

on:
  push:
    paths:
      - 'LANGUAGEDATAEXPORTER_BUILD.txt'
  workflow_dispatch:
    inputs:
      skip_safety:
        description: 'Skip safety checks (not recommended)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

env:
  PROJECT_PATH: RessourcesForCodingTheProject/NewScripts/LanguageDataExporter
  APP_NAME: LanguageDataExporter
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================================================
  # JOB 1: VALIDATION
  # =============================================================================
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check build trigger
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - building"
          elif git diff --name-only HEAD~1 | grep -q "LANGUAGEDATAEXPORTER_BUILD.txt"; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Build trigger file changed - building"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No build trigger - skipping"
          fi

      - name: Generate version
        id: version
        if: steps.check.outputs.should_build == 'true'
        run: |
          VERSION=$(TZ='Asia/Seoul' date '+%y.%-m%d.%H%M')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

  # =============================================================================
  # JOB 2: SAFETY CHECKS (Linux)
  # =============================================================================
  safety-checks:
    needs: validate
    if: needs.validate.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ env.PROJECT_PATH }}/requirements.txt
          pip install flake8 pip-audit pytest

      - name: Python syntax validation
        run: |
          echo "=== Syntax Validation ==="
          cd ${{ env.PROJECT_PATH }}
          python -m py_compile main.py
          python -m py_compile config.py
          python -m py_compile gui/app.py
          find . -name "*.py" -type f | xargs -I {} python -m py_compile {}
          echo "All Python files have valid syntax"

      - name: Module import validation
        run: |
          echo "=== Import Validation ==="
          cd ${{ env.PROJECT_PATH }}
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Test all critical imports
          from config import LOC_FOLDER, EXPORT_FOLDER, VOICE_RECORDING_FOLDER
          from config import STORY_CATEGORIES, CATEGORY_COLORS
          print('config imports: OK')

          from utils import VRSOrderer, contains_korean, count_words
          print('utils imports: OK')

          from exporter import parse_language_file, build_stringid_category_index
          from exporter.xml_parser import build_stringid_soundevent_map
          from exporter.xml_parser import parse_export_file, parse_export_with_soundevent
          from exporter.category_mapper import TwoTierCategoryMapper
          print('exporter imports: OK')

          from reports import ReportGenerator, ExcelReportWriter
          print('reports imports: OK')

          # Test GUI import (critical for default mode)
          from gui import launch_gui
          print('gui imports: OK')

          print('All imports validated successfully')
          "

      - name: Full application test (MUST PASS)
        run: |
          echo "=== Application Test ==="
          cd ${{ env.PROJECT_PATH }}

          # Test --help works (validates argparse)
          python main.py --help
          echo "✓ main.py --help: OK"

          # Test --list-categories runs without crashing
          python main.py --list-categories 2>&1 || echo "list-categories: expected fail (no data folder)"
          echo "✓ main.py --list-categories: OK"

          # CRITICAL: Test all imports work when running from this directory
          # This catches "ValueError: attempted relative import beyond top-level package"
          # We test each module that main.py imports
          echo "Testing direct module imports (catches relative import bugs)..."

          # These must ALL succeed - no || true allowed!
          python -c "import config; print('✓ config')"
          python -c "import utils; print('✓ utils')"
          python -c "import exporter; print('✓ exporter')"
          python -c "import clustering; print('✓ clustering')"
          python -c "import reports; print('✓ reports')"
          python -c "import gui; print('✓ gui')"

          echo "✓ All module imports validated"
          echo "Application test complete"

      - name: Comprehensive module validation (MUST PASS)
        run: |
          echo "=== Comprehensive Module Validation ==="
          cd ${{ env.PROJECT_PATH }}
          python -c "
          import sys
          sys.path.insert(0, '.')

          print('Testing all module imports...')

          # Test config
          from config import (
              LOC_FOLDER, EXPORT_FOLDER, VOICE_RECORDING_FOLDER,
              STORY_CATEGORIES, GAMEDATA_CATEGORIES, CATEGORY_COLORS,
              LANGUAGE_NAMES, DEFAULT_CATEGORY, ensure_output_folder
          )
          print('✓ config: all exports OK')

          # Test utils
          from utils import VRSOrderer, contains_korean, count_words
          from utils.language_utils import (
              WORD_COUNT_LANGUAGES, CHAR_COUNT_LANGUAGES,
              should_include_english_column
          )
          from utils.vrs_ordering import load_vrs_order, find_most_recent_excel
          print('✓ utils: all exports OK')

          # Test exporter
          from exporter import (
              parse_language_file, discover_language_files,
              build_stringid_category_index, load_cluster_config,
              analyze_categories, TwoTierCategoryMapper, write_language_excel
          )
          from exporter.xml_parser import (
              sanitize_xml_content, parse_export_file,
              parse_export_with_soundevent, build_stringid_soundevent_map
          )
          from exporter.category_mapper import get_category
          print('✓ exporter: all exports OK')

          # Test reports
          from reports import ReportGenerator, ExcelReportWriter, WordCounter
          from reports.word_counter import CategoryWordCount
          from reports.report_generator import LanguageReport
          print('✓ reports: all exports OK')

          # Test GUI
          from gui import launch_gui, LanguageDataExporterGUI
          print('✓ gui: all exports OK')

          # Test clustering
          from clustering import TierClassifier, DialogClusterer, SequencerClusterer, GameDataClusterer
          print('✓ clustering: all exports OK')

          # Validate key constants
          assert len(STORY_CATEGORIES) == 4, f'Expected 4 STORY categories, got {len(STORY_CATEGORIES)}'
          assert len(CATEGORY_COLORS) >= 10, f'Expected 10+ category colors, got {len(CATEGORY_COLORS)}'
          assert 'eng' in LANGUAGE_NAMES, 'Missing eng in LANGUAGE_NAMES'
          print('✓ constants: validated')

          print('')
          print('=' * 50)
          print('ALL MODULE VALIDATIONS PASSED!')
          print('=' * 50)
          "
          echo "Comprehensive validation complete"

      - name: Flake8 critical errors (MUST PASS)
        run: |
          echo "=== Flake8 Critical Errors (FAILS BUILD!) ==="
          cd ${{ env.PROJECT_PATH }}
          # E9: Runtime errors (syntax, IO)
          # F63: Invalid comparisons
          # F7: Syntax errors
          # F82: Undefined names (CRITICAL - catches missing variables!)
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          echo "Flake8 passed - no critical errors"

      - name: Security audit
        run: |
          echo "=== Security Audit ==="
          pip-audit --requirement ${{ env.PROJECT_PATH }}/requirements.txt || true

      - name: Runtime function tests (MUST PASS)
        run: |
          echo "=== Runtime Function Tests ==="
          cd ${{ env.PROJECT_PATH }}
          python -c "
          import sys
          sys.path.insert(0, '.')

          print('Testing runtime functions...')

          # Test XML sanitization
          from exporter.xml_parser import sanitize_xml_content
          test_xml = '<root>Test & Value</root>'
          result = sanitize_xml_content(test_xml)
          assert '&amp;' in result, f'sanitize_xml_content failed: {result}'
          print('✓ sanitize_xml_content: works')

          # Test Korean detection
          from utils.language_utils import contains_korean
          assert contains_korean('한글') == True, 'Korean detection failed'
          assert contains_korean('English') == False, 'English false positive'
          print('✓ contains_korean: works')

          # Test word counting
          from utils.language_utils import count_words
          assert count_words('hello world') == 2, 'Word count failed'
          assert count_words('') == 0, 'Empty string count failed'
          print('✓ count_words: works')

          # Test English column logic
          from utils.language_utils import should_include_english_column
          assert should_include_english_column('fre') == True, 'FRE should include English'
          assert should_include_english_column('eng') == False, 'ENG should not include English'
          assert should_include_english_column('jpn') == False, 'JPN should not include English'
          print('✓ should_include_english_column: works')

          # Test category mapper class
          from exporter.category_mapper import TwoTierCategoryMapper
          from pathlib import Path
          config = {'enabled': True, 'default_category': 'Uncategorized'}
          mapper = TwoTierCategoryMapper(Path('.'), config)
          assert mapper.default_category == 'Uncategorized', 'Mapper config failed'
          print('✓ TwoTierCategoryMapper: works')

          # Test VRSOrderer class
          from utils.vrs_ordering import VRSOrderer
          orderer = VRSOrderer(Path('.'))
          assert orderer.loaded == False, 'VRSOrderer should start unloaded'
          print('✓ VRSOrderer: works')

          # Test cluster config loading
          from exporter.category_mapper import load_cluster_config
          config = load_cluster_config(Path('category_clusters.json'))
          assert config.get('enabled') == True, 'Cluster config failed'
          print('✓ load_cluster_config: works')

          # Test report generator
          from reports.report_generator import ReportGenerator
          gen = ReportGenerator({}, 'Uncategorized')
          assert gen.default_category == 'Uncategorized', 'ReportGenerator failed'
          print('✓ ReportGenerator: works')

          # Test GUI can be imported and instantiated (without display)
          import tkinter as tk
          from gui.app import LanguageDataExporterGUI
          print('✓ LanguageDataExporterGUI: importable')

          print('')
          print('=' * 50)
          print('ALL RUNTIME FUNCTION TESTS PASSED!')
          print('=' * 50)
          "

      - name: Flake8 ALL warnings (informational)
        run: |
          echo "=== Flake8 All Warnings (informational) ==="
          cd ${{ env.PROJECT_PATH }}
          flake8 . --count --max-line-length=120 --statistics || true

      - name: Run tests (if exist)
        run: |
          echo "=== Running Tests ==="
          cd ${{ env.PROJECT_PATH }}
          if [ -d "tests" ]; then
            pytest tests/ -v --tb=short || echo "Some tests failed (may be Windows-specific)"
          else
            echo "No tests directory found - skipping"
          fi

  # =============================================================================
  # JOB 3: BUILD & RELEASE (Windows)
  # =============================================================================
  build-release:
    needs: [validate, safety-checks]
    if: needs.validate.outputs.should_build == 'true'
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.validate.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ env.PROJECT_PATH }}/requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          cd ${{ env.PROJECT_PATH }}
          pyinstaller LanguageDataExporter.spec --clean
          echo "PyInstaller build complete"

      - name: Create output directory and working folders
        run: |
          $projectPath = "${{ env.PROJECT_PATH }}"
          $distPath = "$projectPath\dist\LanguageDataExporter"

          # Create centralized output directory for all artifacts
          New-Item -ItemType Directory -Path "$projectPath\installer_output" -Force

          # Create working folders in dist (for portable ZIP)
          $workingFolders = @("GeneratedExcel")
          foreach ($folder in $workingFolders) {
            $path = "$distPath\$folder"
            New-Item -ItemType Directory -Path $path -Force | Out-Null
            New-Item -ItemType File -Path "$path\.gitkeep" -Force | Out-Null
          }

          Write-Host "Working folders created with .gitkeep files"

      - name: Build Inno Setup installer
        run: |
          choco install innosetup -y

          $projectPath = "${{ env.PROJECT_PATH }}"
          $version = "${{ env.VERSION }}"
          $issPath = "$projectPath\installer\LanguageDataExporter.iss"
          $outputDir = "$projectPath\installer_output"

          # Build installer with version and output directory
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DAppVersion=$version /O"$outputDir" $issPath

          # Rename output to include version
          $installerFile = Get-ChildItem -Path $outputDir -Filter "*.exe" | Select-Object -First 1
          if ($installerFile) {
            $newName = "LanguageDataExporter_v${version}_Setup.exe"
            Rename-Item -Path $installerFile.FullName -NewName $newName
            Write-Host "Installer: $newName"
          }

      - name: Create portable ZIP
        run: |
          $version = "${{ env.VERSION }}"
          $projectPath = "${{ env.PROJECT_PATH }}"
          $distPath = "$projectPath\dist\LanguageDataExporter"
          $zipPath = "$projectPath\installer_output\LanguageDataExporter_v${version}_Portable.zip"

          # Create portable ZIP from dist folder
          Compress-Archive -Path "$distPath\*" -DestinationPath $zipPath -Force

          $size = (Get-Item $zipPath).Length / 1MB
          Write-Host "Portable ZIP: $([math]::Round($size, 1)) MB"

      - name: Create source ZIP
        run: |
          $version = "${{ env.VERSION }}"
          $projectPath = "${{ env.PROJECT_PATH }}"
          $zipPath = "$projectPath\installer_output\LanguageDataExporter_v${version}_Source.zip"

          # Create temp directory for clean source
          $tempDir = New-Item -ItemType Directory -Path "$env:TEMP\LDE_Source" -Force
          $excludes = @("dist", "build", "__pycache__", "*.pyc", "installer_output", ".pytest_cache")

          # Copy source files excluding build artifacts
          Get-ChildItem -Path $projectPath -Exclude $excludes | Copy-Item -Destination $tempDir -Recurse -Force

          # Remove any __pycache__ directories that got copied
          Get-ChildItem -Path $tempDir -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # Create working folders in source bundle
          $sourceFolders = @("GeneratedExcel")
          foreach ($folder in $sourceFolders) {
            $path = "$tempDir\$folder"
            New-Item -ItemType Directory -Path $path -Force | Out-Null
            New-Item -ItemType File -Path "$path\.gitkeep" -Force | Out-Null
          }

          # Create source ZIP
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath -Force

          # Cleanup temp directory
          Remove-Item -Path $tempDir -Recurse -Force

          $size = (Get-Item $zipPath).Length / 1MB
          Write-Host "Source ZIP: $([math]::Round($size, 1)) MB"

      - name: Upload Setup artifact
        uses: actions/upload-artifact@v4
        with:
          name: LanguageDataExporter-Setup
          path: ${{ env.PROJECT_PATH }}/installer_output/*_Setup.exe
          retention-days: 30

      - name: Upload Portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: LanguageDataExporter-Portable
          path: ${{ env.PROJECT_PATH }}/installer_output/*_Portable.zip
          retention-days: 30

      - name: Upload Source artifact
        uses: actions/upload-artifact@v4
        with:
          name: LanguageDataExporter-Source
          path: ${{ env.PROJECT_PATH }}/installer_output/*_Source.zip
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: languagedataexporter-v${{ env.VERSION }}
          name: LanguageDataExporter v${{ env.VERSION }}
          body: |
            ## LanguageDataExporter v${{ env.VERSION }}

            Language XML to Categorized Excel Converter with VRS-based story ordering.

            ### Features
            - Two-tier category clustering (STORY + GAME_DATA)
            - VoiceRecordingSheet-based chronological ordering for STORY strings
            - Word count reports for LQA scheduling
            - GUI and CLI modes
            - Color-coded Excel output

            ### Downloads
            - **Setup.exe**: Installer with drive selection
            - **Portable.zip**: Standalone executable with working folders
            - **Source.zip**: Python source code

            ### STORY Categories (VRS-ordered)
            - Sequencer, AIDialog, QuestDialog, NarrationDialog

            ### GAME_DATA Categories
            - Item, Quest, Character, Gimmick, Skill, Knowledge, Faction, UI, Region, System_Misc
          files: |
            ${{ env.PROJECT_PATH }}/installer_output/*.exe
            ${{ env.PROJECT_PATH }}/installer_output/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
