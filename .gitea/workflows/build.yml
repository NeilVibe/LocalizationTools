# ============================================================================
# LocaNext Build Pipeline - Gitea Actions
# MIRRORS GITHUB WORKFLOW EXACTLY (832 lines → Gitea compatible)
# ============================================================================
# This workflow is 100% identical to .github/workflows/build-electron.yml
# with only these Gitea-specific adaptations:
#   - windows-latest → self-hosted (Windows runner required)
#   - softprops/action-gh-release → Gitea REST API
#   - gh release list → Gitea API
#   - GITHUB_TOKEN → RELEASE_TOKEN (GITEA_ prefix is reserved)
# ============================================================================

name: Build LocaNext LIGHT Installer

on:
  push:
    branches: [ main ]
    paths:
      - 'GITEA_TRIGGER.txt'
  workflow_dispatch:

env:
  GITEA_URL: http://localhost:3000
  GITEA_REPO: neilvibe/LocaNext

jobs:
  # ============================================================
  # JOB 1: Check Build Trigger (IDENTICAL TO GITHUB)
  # ============================================================
  check-build-trigger:
    name: Check Build Trigger
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check GITEA_TRIGGER.txt
        id: check
        run: |
          TRIGGER=$(cat GITEA_TRIGGER.txt | grep -E "Build (LIGHT|FULL)" | tail -1)
          echo "Trigger line: $TRIGGER"

          if echo "$TRIGGER" | grep -qE "Build (LIGHT|FULL)"; then
            echo "should_build=true" >> $GITHUB_OUTPUT

            # Extract version (first match only - ignore "v2" in comments like "Fix v2")
            VERSION=$(echo "$TRIGGER" | grep -oE 'v[0-9]{10}' | head -1 | sed 's/v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "[OK] Build triggered for version: $VERSION"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No build trigger found"
          fi

  # ============================================================
  # JOB 2: Safety Checks (IDENTICAL TO GITHUB)
  # ============================================================
  safety-checks:
    name: Safety Checks (Tests, Security, Version)
    runs-on: ubuntu-latest
    needs: check-build-trigger
    if: needs.check-build-trigger.outputs.should_build == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Host mode: Use system Python 3.11 and Node directly (no setup actions needed)
      - name: Verify Python 3.11
        run: |
          python3.11 --version
          python3.11 -m pip --version

      - name: Verify Node.js
        run: |
          node --version
          npm --version

      - name: Install Python Dependencies
        run: |
          python3.11 -m pip install --upgrade pip
          python3.11 -m pip install -r requirements.txt
          python3.11 -m pip install pytest pip-audit

      - name: Install Node Dependencies
        run: |
          cd locaNext && npm ci

      # ---- VERSION CHECK ----
      - name: Version Unification Check
        run: |
          echo "=== Checking version unification across all files ==="
          python3.11 scripts/check_version_unified.py
          echo "[OK] All versions unified"

      # ---- VERSION INCREMENT CHECK (GITEA API) ----
      - name: Check Version Increment
        run: |
          echo "=== Checking version is newer than latest release ==="

          # Get current version from version.py
          CURRENT_VERSION=$(python3.11 -c "from version import VERSION; print(VERSION)")
          echo "Current version: $CURRENT_VERSION"

          # Get latest release version from Gitea API
          LATEST_TAG=$(curl -s "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases?limit=1" \
            -H "Authorization: token ${{ secrets.RELEASE_TOKEN }}" | \
            jq -r '.[0].tag_name // "v0"')
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/v//')
          echo "Latest release: $LATEST_VERSION"

          # Compare versions (both are YYMMDDHHMM format, simple numeric comparison)
          if [ "$CURRENT_VERSION" -le "$LATEST_VERSION" ] 2>/dev/null; then
            echo "[WARNING] Current version ($CURRENT_VERSION) is not greater than latest release ($LATEST_VERSION)"
            echo "Consider updating VERSION in version.py"
          else
            echo "[OK] Version $CURRENT_VERSION is newer than $LATEST_VERSION"
          fi

      # ---- SERVER LAUNCH TEST ----
      - name: Test Server Starts
        run: |
          echo "=== Testing server can start (catches missing files) ==="
          # Start server in background
          timeout 30 python3.11 server/main.py &
          SERVER_PID=$!

          # Wait for server with retries
          for i in {1..10}; do
            sleep 2
            echo "Checking server... ($i/10)"
            if curl -s http://localhost:8888/health | grep -q "healthy"; then
              echo "[OK] Server started successfully"
              kill $SERVER_PID 2>/dev/null || true
              exit 0
            fi
          done

          echo "[ERROR] Server failed to start!"
          kill $SERVER_PID 2>/dev/null || true
          exit 1

      # ---- PYTHON TESTS ----
      - name: Run Python Tests
        run: |
          echo "=== Running E2E unit tests (core functionality, no server required) ==="
          python3.11 -m pytest \
            tests/e2e/test_kr_similar_e2e.py \
            tests/e2e/test_xlstransfer_e2e.py \
            tests/e2e/test_quicksearch_e2e.py \
            tests/unit/ \
            -v --tb=short --no-cov -x
          echo "[OK] All Python tests passed"

      # ---- SECURITY AUDITS ----
      - name: Python Security Audit
        run: |
          echo "=== Checking Python dependencies for vulnerabilities ==="
          pip-audit --desc || echo "Vulnerabilities found - logged for review"
          echo "[OK] Python security audit complete"
        continue-on-error: true

      - name: NPM Security Audit
        run: |
          cd locaNext
          npm audit || echo "Vulnerabilities found - logged for review"
          echo "[OK] NPM security audit complete"
        continue-on-error: true

      - name: Safety Checks Summary
        run: |
          echo "============================================"
          echo "[PASS] SAFETY CHECKS PASSED"
          echo "============================================"

  # ============================================================
  # JOB 3: Build Windows Installer (REQUIRES WINDOWS SELF-HOSTED RUNNER)
  # ============================================================
  build-windows:
    name: Build Windows LIGHT Installer
    runs-on: [self-hosted, windows, x64]  # GITEA: Use self-hosted Windows runner
    needs: [check-build-trigger, safety-checks]
    if: needs.check-build-trigger.outputs.should_build == 'true'

    steps:
      # GITEA FIX: Add Git to PATH for self-hosted Windows runner
      - name: Setup Windows Environment
        run: |
          Write-Host "Adding Git to GITHUB_PATH..."
          Add-Content -Path $env:GITHUB_PATH -Value "E:\GIT123\Git\cmd" -Encoding utf8
          Add-Content -Path $env:GITHUB_PATH -Value "E:\GIT123\Git\bin" -Encoding utf8
          Write-Host "Verifying Git installation..."
          & "E:\GIT123\Git\cmd\git.exe" --version
          Write-Host "Environment setup complete"
        shell: powershell

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: locaNext/package-lock.json

      # ============================================================
      # STEP 1: Download VC++ Redistributable
      # ============================================================
      - name: Download VC++ Redistributable
        run: |
          Write-Host "Downloading VC++ Redistributable x64..."
          New-Item -ItemType Directory -Force -Path "installer\redist"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "installer\redist\vc_redist.x64.exe"
          $size = (Get-Item "installer\redist\vc_redist.x64.exe").length / 1MB
          Write-Host "[OK] Downloaded VC++ Redistributable: $([math]::Round($size, 1)) MB"
        shell: powershell

      # ============================================================
      # STEP 2: Download Python Embedded
      # ============================================================
      - name: Download Python Embedded
        run: |
          Write-Host "Downloading Python Embedded (portable)..."
          New-Item -ItemType Directory -Force -Path "tools\python"

          $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          $zipPath = "tools\python-embedded.zip"

          Invoke-WebRequest -Uri $pythonUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "tools\python" -Force
          Remove-Item $zipPath

          # Enable pip in embedded Python
          $pthFile = Get-ChildItem "tools\python\python*._pth" | Select-Object -First 1
          if ($pthFile) {
            $content = Get-Content $pthFile.FullName
            $content = $content -replace '#import site', 'import site'
            Set-Content -Path $pthFile.FullName -Value $content
          }

          # Install pip
          Write-Host "Installing pip in embedded Python..."
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "tools\python\get-pip.py"
          & "tools\python\python.exe" "tools\python\get-pip.py" --no-warn-script-location
          Remove-Item "tools\python\get-pip.py"

          # Install dependencies
          Write-Host "Installing huggingface_hub..."
          & "tools\python\python.exe" -m pip install --no-warn-script-location huggingface_hub

          Write-Host "Installing light backend dependencies..."
          & "tools\python\python.exe" -m pip install --no-warn-script-location `
            fastapi uvicorn python-multipart python-socketio `
            sqlalchemy aiosqlite `
            PyJWT python-jose passlib python-dotenv bcrypt `
            pydantic pydantic-settings email-validator `
            pandas openpyxl xlrd `
            httpx requests loguru tqdm pyyaml

          $totalSize = (Get-ChildItem "tools\python" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "[OK] Python Embedded ready: $([math]::Round($totalSize, 1)) MB"
        shell: powershell

      - name: Verify Python Embedded + ALL Dependencies
        run: |
          Write-Host "Verifying embedded Python setup..."
          & "tools\python\python.exe" --version

          Write-Host "=== Checking ALL critical packages ==="
          & "tools\python\python.exe" -c "import fastapi; print(f'[OK] fastapi v{fastapi.__version__}')"
          & "tools\python\python.exe" -c "import uvicorn; print('[OK] uvicorn ready')"
          & "tools\python\python.exe" -c "import socketio; print('[OK] socketio ready')"
          & "tools\python\python.exe" -c "import sqlalchemy; print(f'[OK] sqlalchemy v{sqlalchemy.__version__}')"
          & "tools\python\python.exe" -c "import aiosqlite; print('[OK] aiosqlite ready')"
          & "tools\python\python.exe" -c "import jwt; print(f'[OK] jwt v{jwt.__version__}')"
          & "tools\python\python.exe" -c "from jose import jwt as jose_jwt; print('[OK] jose.jwt ready')"
          & "tools\python\python.exe" -c "import passlib; print('[OK] passlib ready')"
          & "tools\python\python.exe" -c "import bcrypt; print('[OK] bcrypt ready')"
          & "tools\python\python.exe" -c "import pydantic; print(f'[OK] pydantic v{pydantic.__version__}')"
          & "tools\python\python.exe" -c "import pandas; print(f'[OK] pandas v{pandas.__version__}')"
          & "tools\python\python.exe" -c "import openpyxl; print('[OK] openpyxl ready')"
          & "tools\python\python.exe" -c "import huggingface_hub; print(f'[OK] huggingface_hub v{huggingface_hub.__version__}')"

          # Check required files
          if (!(Test-Path "version.py")) { Write-Error "[ERROR] version.py not found"; exit 1 }
          if (!(Test-Path "server\main.py")) { Write-Error "[ERROR] server/main.py not found"; exit 1 }
          Write-Host "[PASS] All dependencies verified!"
        shell: powershell

      - name: Test Server Launch with Embedded Python
        run: |
          Write-Host "=== Testing server can START with embedded Python ==="
          $env:PYTHONPATH = Get-Location
          & "tools\python\python.exe" -c "import sys; sys.path.insert(0,'.'); from version import VERSION; print(f'version OK: v{VERSION}'); import server.main; print('server.main OK')"
          if ($LASTEXITCODE -ne 0) { Write-Error "Server import test FAILED!"; exit 1 }
          Write-Host "Server launch test passed!"
        shell: powershell

      # ============================================================
      # STEP 3: Build Electron app
      # ============================================================
      - name: Install Node Dependencies
        run: |
          cd locaNext
          npm ci
        shell: powershell

      # GITEA FIX: Clear corrupted electron-builder cache (symlink issues)
      - name: Clear Electron Builder Cache
        run: |
          Write-Host "Clearing electron-builder cache to avoid symlink issues..."
          $cachePath = "$env:LOCALAPPDATA\electron-builder\Cache\winCodeSign"
          if (Test-Path $cachePath) {
            Remove-Item -Path $cachePath -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "[OK] Cleared winCodeSign cache"
          } else {
            Write-Host "[INFO] No cache to clear"
          }
        shell: powershell

      - name: Build Electron App
        run: |
          cd locaNext
          npm run build
          npm run build:electron
        shell: powershell
        env:
          # Disable code signing completely for unsigned builds
          # CSC_IDENTITY_AUTO_DISCOVERY: false alone is sufficient
          # DO NOT set WIN_CSC_LINK="" - it's treated as a file path!
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          # Debug output
          DEBUG: electron-builder

      - name: Verify Electron Build
        run: |
          if (!(Test-Path "locaNext\dist-electron\win-unpacked\LocaNext.exe")) {
            Write-Error "[ERROR] Electron build failed - LocaNext.exe not found"
            exit 1
          }
          Write-Host "[OK] Electron build successful"
        shell: powershell

      # ============================================================
      # STEP 4: Compile Inno Setup installer
      # ============================================================
      - name: Setup Inno Setup Path
        run: |
          # Check common Inno Setup locations and add to PATH
          $innoLocations = @(
            "C:\Program Files (x86)\Inno Setup 6",
            "C:\Program Files\Inno Setup 6",
            "$env:LOCALAPPDATA\Programs\Inno Setup 6"
          )

          foreach ($loc in $innoLocations) {
            if (Test-Path "$loc\ISCC.exe") {
              Write-Host "[OK] Found Inno Setup at: $loc"
              $env:Path += ";$loc"
              [Environment]::SetEnvironmentVariable('Path', $env:Path, 'Process')
              break
            }
          }

          # Verify ISCC is accessible
          $iscc = Get-Command ISCC.exe -ErrorAction SilentlyContinue
          if ($iscc) {
            Write-Host "[OK] ISCC.exe found: $($iscc.Source)"
          } else {
            Write-Host "Inno Setup not found - installing via choco..."
            choco install innosetup -y
          }
        shell: powershell

      - name: Compile LIGHT Installer
        run: |
          Write-Host "Compiling LIGHT Windows installer..."
          ISCC.exe installer\locanext_light.iss
        shell: powershell

      - name: Verify Installer
        run: |
          $version = "${{ needs.check-build-trigger.outputs.version }}"
          $installer = Get-ChildItem "installer_output\*.exe" | Select-Object -First 1
          if (!$installer) { Write-Error "[ERROR] No installer found"; exit 1 }
          Write-Host "[OK] LIGHT Installer compiled: $($installer.Name)"
          $size = $installer.length / 1MB
          Write-Host "  Size: $([math]::Round($size, 1)) MB"
        shell: powershell

      # ============================================================
      # STEP 5: Generate latest.yml for Auto-Update
      # ============================================================
      - name: Generate latest.yml for Auto-Update
        run: |
          Write-Host "=== Generating latest.yml for electron-updater ==="
          $version = "${{ needs.check-build-trigger.outputs.version }}"

          $installer = Get-ChildItem "installer_output\*.exe" | Select-Object -First 1
          if (!$installer) { Write-Error "[ERROR] No installer found"; exit 1 }

          $fileName = $installer.Name
          $fileSize = $installer.Length
          $hash = (Get-FileHash -Path $installer.FullName -Algorithm SHA512).Hash.ToLower()

          $env:PYTHONPATH = Get-Location
          $semanticVersion = & "tools\python\python.exe" -c "import sys; sys.path.insert(0,'.'); from version import SEMANTIC_VERSION; print(SEMANTIC_VERSION)"
          if (!$semanticVersion) { $semanticVersion = "1.0.0" }

          $releaseDate = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")

          $latestYml = "version: $semanticVersion`nfiles:`n  - url: $fileName`n    sha512: $hash`n    size: $fileSize`npath: $fileName`nsha512: $hash`nreleaseDate: '$releaseDate'"

          $latestYml | Out-File -FilePath "installer_output\latest.yml" -Encoding UTF8 -NoNewline
          Write-Host "[OK] latest.yml generated"
          Get-Content "installer_output\latest.yml"
        shell: powershell

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LocaNext-Windows-LIGHT-Setup
          path: |
            installer_output/*.exe
            installer_output/latest.yml
          retention-days: 7

      # ============================================================
      # POST-BUILD TESTS (Same as GitHub)
      # ============================================================
      - name: Test Install (Silent)
        run: |
          Write-Host "=== POST-BUILD TEST: Installing app silently ==="
          $installer = Get-ChildItem "installer_output\*.exe" | Select-Object -First 1
          $installDir = "$env:TEMP\LocaNext_Test"
          Start-Process -FilePath $installer.FullName `
            -ArgumentList "/SILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/DIR=$installDir" `
            -Wait -NoNewWindow
          Write-Host "[OK] Installation completed to: $installDir"
        shell: powershell

      - name: Verify Installation Files
        run: |
          $installDir = "$env:TEMP\LocaNext_Test"
          if (!(Test-Path "$installDir\LocaNext.exe")) { Write-Error "[ERROR] LocaNext.exe not found"; exit 1 }
          if (!(Test-Path "$installDir\server\main.py")) { Write-Error "[ERROR] server/main.py not found"; exit 1 }
          if (!(Test-Path "$installDir\version.py")) { Write-Error "[ERROR] version.py not found"; exit 1 }
          if (!(Test-Path "$installDir\tools\python\python.exe")) { Write-Error "[ERROR] Embedded Python not found"; exit 1 }
          Write-Host "[PASS] All critical files present!"
        shell: powershell

      - name: Test Backend Actually Runs (Health Check)
        run: |
          Write-Host "=== Testing backend ACTUALLY STARTS and responds ==="
          $installDir = "$env:TEMP\LocaNext_Test"
          $pythonExe = "$installDir\tools\python\python.exe"
          $serverScript = "$installDir\server\main.py"

          $env:PYTHONPATH = $installDir
          $env:PYTHONUNBUFFERED = "1"

          $process = Start-Process -FilePath $pythonExe -ArgumentList $serverScript `
            -WorkingDirectory $installDir -PassThru -NoNewWindow `
            -RedirectStandardOutput "$env:TEMP\server_out.log" `
            -RedirectStandardError "$env:TEMP\server_err.log"

          $maxRetries = 15
          $serverReady = $false

          for ($i = 1; $i -le $maxRetries; $i++) {
            Start-Sleep 2
            Write-Host "Checking server... ($i/$maxRetries)"
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8888/health" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "[OK] Server responded: $($response.Content)"
                $serverReady = $true
                break
              }
            } catch { Write-Host "  Not ready yet..." }
          }

          if (!$process.HasExited) { Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue }

          if (!$serverReady) {
            Write-Host "=== Server stderr ==="
            if (Test-Path "$env:TEMP\server_err.log") { Get-Content "$env:TEMP\server_err.log" -Tail 50 }
            Write-Error "[ERROR] Backend failed to start!"
            exit 1
          }
          Write-Host "[PASS] Backend starts and responds to /health!"
        shell: powershell

      - name: Cleanup Test Installation
        if: always()
        run: |
          $installDir = "$env:TEMP\LocaNext_Test"
          if (Test-Path $installDir) {
            Remove-Item -Recurse -Force $installDir -ErrorAction SilentlyContinue
            Write-Host "[OK] Test installation cleaned up"
          }
        shell: powershell

  # ============================================================
  # JOB 4: Create Gitea Release (GITEA API - replaces softprops/action-gh-release)
  # ============================================================
  create-release:
    name: Create Gitea Release
    runs-on: ubuntu-latest
    needs: [check-build-trigger, build-windows]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: LocaNext-Windows-LIGHT-Setup
          path: artifacts/windows

      - name: List Downloaded Artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la artifacts/windows/

      - name: Create Gitea Release via API
        run: |
          VERSION="${{ needs.check-build-trigger.outputs.version }}"
          TAG="v${VERSION}"

          echo "Creating release: $TAG"

          # Create release body
          BODY=$(cat << 'RELEASE_BODY'
          ## LocaNext Desktop Application (LIGHT Build)

          **Version:** VERSION_PLACEHOLDER
          **Build Type:** LIGHT (deps + model installed on first launch)
          **Built by:** Gitea Actions

          ### Downloads
          - `LocaNext_vVERSION_PLACEHOLDER_Light_Setup.exe` (~150-200MB)

          ### Requirements
          - Internet connection for first launch setup
          - ~3GB disk space for app + deps + model
          - NO Python required - everything bundled

          ### Default Credentials
          - Username: admin
          - Password: admin123

          ---
          Built with Gitea Actions
          RELEASE_BODY
          )

          # Replace placeholder
          BODY=$(echo "$BODY" | sed "s/VERSION_PLACEHOLDER/${VERSION}/g")

          # Create release via Gitea API
          RESPONSE=$(curl -s -X POST "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases" \
            -H "Authorization: token ${{ secrets.RELEASE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag_name\": \"${TAG}\",
              \"name\": \"LocaNext ${TAG} (LIGHT)\",
              \"body\": $(echo "$BODY" | jq -Rs .),
              \"draft\": false,
              \"prerelease\": false
            }")

          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" == "null" ]; then
            echo "[ERROR] Failed to create release"
            echo "$RESPONSE"
            exit 1
          fi

          echo "[OK] Release created with ID: $RELEASE_ID"
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV

      - name: Upload Release Assets
        run: |
          echo "Uploading assets to release $RELEASE_ID..."

          # Upload .exe
          for exe in artifacts/windows/*.exe; do
            if [ -f "$exe" ]; then
              FILENAME=$(basename "$exe")
              echo "  Uploading: $FILENAME"
              curl -s -X POST "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/${RELEASE_ID}/assets?name=${FILENAME}" \
                -H "Authorization: token ${{ secrets.RELEASE_TOKEN }}" \
                -F "attachment=@${exe}"
            fi
          done

          # Upload latest.yml
          if [ -f "artifacts/windows/latest.yml" ]; then
            echo "  Uploading: latest.yml"
            curl -s -X POST "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/${RELEASE_ID}/assets?name=latest.yml" \
              -H "Authorization: token ${{ secrets.RELEASE_TOKEN }}" \
              -F "attachment=@artifacts/windows/latest.yml"
          fi

          echo "[OK] All assets uploaded"

      - name: Update Latest Tag
        run: |
          VERSION="${{ needs.check-build-trigger.outputs.version }}"
          echo "Updating 'latest' tag to point to v${VERSION}..."

          # This is done via git, similar to GitHub workflow
          git config user.name "Gitea Actions"
          git config user.email "actions@gitea.local"
          git tag -f latest
          git push -f origin latest || echo "Could not update latest tag (non-blocking)"
        continue-on-error: true

      - name: Release Summary
        run: |
          VERSION="${{ needs.check-build-trigger.outputs.version }}"
          echo "============================================"
          echo "[SUCCESS] Gitea Release Created!"
          echo "============================================"
          echo "Version: v${VERSION}"
          echo "URL: ${GITEA_URL}/${GITEA_REPO}/releases/tag/v${VERSION}"
          echo "============================================"
