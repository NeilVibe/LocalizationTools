# CI/CD Hub

**LocaNext Continuous Integration & Deployment**

---

## Technology Stack

| Component | Technology | Notes |
|-----------|------------|-------|
| **CI/CD Primary** | Gitea Actions | Self-hosted, Linux runner (host mode) |
| **CI/CD Secondary** | GitHub Actions | Cloud, Windows runner |
| **Installer Builder** | electron-builder 26.x | Native NSIS support |
| **Installer Format** | NSIS (Nullsoft) | Replaced Inno Setup in P28 |
| **Build Output** | `LocaNext_v*.exe` | ~200MB Light, ~2GB Full |

---

## Quick Reference

| Need | Go To |
|------|-------|
| Build now? | [HOW_TO_BUILD.md](HOW_TO_BUILD.md) |
| Build failed? | [TROUBLESHOOTING.md](TROUBLESHOOTING.md) |
| Pipeline details? | [PIPELINE_ARCHITECTURE.md](PIPELINE_ARCHITECTURE.md) |
| Version format? | [VERSION_SYSTEM.md](VERSION_SYSTEM.md) |
| **Runner services?** | [RUNNER_SERVICE_SETUP.md](RUNNER_SERVICE_SETUP.md) |
| **CPU issues?** | [../troubleshooting/GITEA_SAFETY_PROTOCOL.md](../troubleshooting/GITEA_SAFETY_PROTOCOL.md) |

---

## 3 Build Modes

| Mode | Trigger | Description |
|------|---------|-------------|
| **Build LIGHT** | `Build LIGHT - desc` | Full official build (~200MB) |
| **Build FULL** | `Build FULL - desc` | Same + bundled AI model (~2GB) |
| **TROUBLESHOOT** | `TROUBLESHOOT` | Smart checkpoint mode |

---

## TROUBLESHOOT Mode

Smart checkpoint that **persists across CI runs**:

```
1. Trigger: TROUBLESHOOT
   ↓
2. No checkpoint? → Run all tests
   Checkpoint exists? → Run that test first
   ↓
3. Test fails? → Save checkpoint, exit
   ↓
4. Fix code, push, trigger TROUBLESHOOT again
   ↓
5. Repeat until all pass
   ↓
6. Do Build LIGHT for official release
```

**Checkpoint location:** `/home/neil1988/.locanext_checkpoint`

---

## Pipeline Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                    LOCANEXT CI/CD PIPELINE                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  TRIGGER: Push to main with trigger in GITEA_TRIGGER.txt           │
│                          ↓                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ JOB 1: check-build-trigger (Linux)                          │   │
│  │ - Parse GITEA_TRIGGER.txt                                   │   │
│  │ - AUTO-GENERATE version: YY.MMDD.HHMM                       │   │
│  │ - Detect mode: OFFICIAL or TROUBLESHOOT                     │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
│                             ↓                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ JOB 2: safety-checks (Linux)                                │   │
│  │ - Inject version into all files                             │   │
│  │ - Run pytest (900+ tests)                                   │   │
│  │ - TROUBLESHOOT: Save checkpoint on failure                  │   │
│  │ - Security audit                                            │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
│                             ↓ (if mode=official)                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ JOB 3: build-windows (Windows self-hosted)                  │   │
│  │ - Build Electron app with electron-builder                  │   │
│  │ - Create NSIS installer (.exe)                              │   │
│  │ - Generate latest.yml for auto-updater                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Version System

**Unified Format:** `YY.MMDD.HHMM` (e.g., `25.1213.1540`)

- Valid semver (25.1213.1540 = X.Y.Z)
- Human readable (Dec 13, 2025, 15:40 KST)
- Auto-generated by pipeline
- Injected into all files automatically

---

## Quick Start

```bash
# Official build
echo "Build LIGHT - feature X" >> GITEA_TRIGGER.txt
git add -A && git commit -m "Build" && git push origin main && git push gitea main

# Troubleshoot mode
echo "TROUBLESHOOT" >> GITEA_TRIGGER.txt
git add -A && git commit -m "Troubleshoot" && git push origin main && git push gitea main
```

---

## Log Locations

```bash
# Find latest build logs
ls -lt ~/gitea/data/actions_log/neilvibe/LocaNext/ | head -5

# Check for errors
cat ~/gitea/data/actions_log/neilvibe/LocaNext/<folder>/*.log | grep -E "FAILED|error"

# Check checkpoint
cat ~/.locanext_checkpoint
```

---

*Last updated: 2025-12-14*
