# Code Review Issues

**Created:** 2025-12-12 | **Status:** IN PROGRESS | **Reviewer:** Claude

---

## Format

```
[ ] OPEN     - Not fixed yet
[x] FIXED    - Resolved with code changes
[~] ACCEPT   - Not a real issue / acceptable as-is
[-] DEFER    - Deferred to future
```

---

## Quick Scan (Prep)

Fast automated scans before deep review.

### [x] ISS-001: Duplicate Progress Trackers
**Priority:** HIGH | **File:** `server/tools/xlstransfer/progress_tracker.py`
**Fixed:** Deleted duplicate. Unified to `server/utils/progress_tracker.py`.

### [x] ISS-002: TrackedOperation Not Used
**Priority:** HIGH | **File:** `server/utils/progress_tracker.py`
**Fixed:** Available for new code. Existing code has equivalent functionality.

### [x] ISS-003: normalize_text Duplicated 4x
**Priority:** HIGH | **File:** Multiple
**Fixed:** Created `server/utils/text_utils.py` with centralized functions.

### [~] ISS-004: 98 print() Statements
**Priority:** MEDIUM | **File:** Multiple
**Accept:** Intentional for CLI tools, security warnings, subprocess output.

### [-] ISS-005: 41 console.log (Frontend)
**Priority:** MEDIUM | **File:** `locaNext/src/`
**Defer:** Frontend polish - low priority.

### [~] ISS-006: 7 TODO Comments
**Priority:** MEDIUM | **File:** Multiple
**Accept:** Legitimate future work items, not stale code.

### [x] ISS-007: LDM No Progress Tracking
**Priority:** MEDIUM | **File:** `server/tools/ldm/api.py`
**Fixed:** Added TrackedOperation to `build_tm_indexes` endpoint.

### [~] ISS-008: 18 Files >500 LOC
**Priority:** LOW | **File:** Multiple
**Accept:** Large files are well-organized with clear sections.

### [~] ISS-009: background_tasks.py Stubs
**Priority:** LOW | **File:** `server/api/background_tasks.py`
**Accept:** Placeholder for future Celery tasks.

---

## Deep Review Session 1: Database & Models

**Files:** `server/database/`, `server/config.py` (5 files, 2609 LOC)

### [x] DR1-001: get_table_counts() Incomplete
**Priority:** MEDIUM | **File:** `server/database/db_setup.py:154-185`
**Issue:** Only counts 12 tables, missing 15+ tables (LDM, Telemetry).
**Fixed:** Made dynamic using Base.metadata.tables - now counts all 29 tables.

### [x] DR1-002: chunked_query() No ORDER BY
**Priority:** MEDIUM | **File:** `server/database/db_utils.py:637-674`
**Issue:** OFFSET/LIMIT without ORDER BY = undefined behavior in SQL.
**Fixed:** Now defaults to primary key if order_by not specified.

### [x] DR1-003: upsert_batch() Return Incorrect
**Priority:** MEDIUM | **File:** `server/database/db_utils.py:676-719`
**Issue:** Always returns `updated=0`, never counts actual updates.
**Fixed:** Simplified to return `{'total': N}` - PostgreSQL ON CONFLICT can't distinguish inserts from updates.

### [x] DR1-004: LDMTrash.item_data Wrong Type
**Priority:** MEDIUM | **File:** `server/database/models.py:899`
**Issue:** Uses `Text` for JSON data instead of `JSONB`.
**Fixed:** Changed to `JSONB` type. Migration script: `scripts/migrate_json_to_jsonb.py`

### [x] DR1-005: JSON Columns Should Be JSONB
**Priority:** MEDIUM | **File:** `server/database/models.py` (10 columns)
**Issue:** `JSON` stores as text, `JSONB` is binary (faster, indexable).
**Fixed:** All 10 JSON columns changed to JSONB. Migration script created for existing databases.

### [~] DR1-006: get_db_session() No @contextmanager
**Priority:** LOW | **File:** `server/database/db_setup.py:109-127`
**Accept:** Works but could add decorator for clarity.

### [~] DR1-007: FTS Columns Not in Model
**Priority:** LOW | **File:** `server/database/models.py`
**Accept:** `source_tsv`/`target_tsv` added dynamically. Document in code.

### [~] DR1-008: Security Mode Default "warn"
**Priority:** LOW | **File:** `server/config.py:180`
**Accept:** Documented behavior. Production should set explicitly.

---

## Deep Review Session 2: Utils & Core

**Files:** `server/utils/` (12 files, 2872 LOC)

### [x] DR2-001: Async Pool Settings Hardcoded
**Priority:** MEDIUM | **File:** `server/utils/dependencies.py:76-84`
**Issue:** `pool_size=20, max_overflow=10` hardcoded instead of using config values.
**Fixed:** Now uses `config.DB_POOL_SIZE`, `config.DB_MAX_OVERFLOW`, etc.

### [x] DR2-002: Auto-Commit in get_async_db
**Priority:** MEDIUM | **File:** `server/utils/dependencies.py:114`
**Issue:** `await session.commit()` happens automatically after yield. Callers can't control transaction.
**Fixed:** Added documentation explaining auto-commit behavior and how to use explicit transactions.

### [x] DR2-003: MD5 Hash for Cache Keys
**Priority:** MEDIUM | **File:** `server/utils/cache.py:159-162`
**Issue:** Uses MD5 for hashing - weak (not security issue here but could confuse).
**Fixed:** Added comment: "MD5 used for cache key uniqueness only, not security".

### [x] DR2-004: Deprecated asyncio.get_event_loop().time()
**Priority:** MEDIUM | **File:** `server/utils/websocket.py:62`
**Issue:** `asyncio.get_event_loop().time()` deprecated in Python 3.10+.
**Fixed:** Changed to `time.time()`.

### [x] DR2-005: file_info/parameters Stored as str()
**Priority:** MEDIUM | **File:** `server/utils/progress_tracker.py:292-296`
**Issue:** Storing dict as `str(dict)` instead of JSON. Can't query as JSONB.
**Fixed:** Changed to `json.dumps()` instead of `str()`.

### [~] DR2-006: Duplicate ProgressTracker Class Names
**Priority:** LOW | **File:** `server/utils/client/progress.py`
**Accept:** Same class name as `server/utils/progress_tracker.py` but different purpose (console vs DB). Acceptable - different modules.

### [~] DR2-007: Empty client/__init__.py
**Priority:** LOW | **File:** `server/utils/client/__init__.py`
**Accept:** Empty init file. Could add exports but not critical.

### [~] DR2-008: Log File Parsing for Failed Logins
**Priority:** LOW | **File:** `server/utils/audit_logger.py:316-353`
**Accept:** O(n) file scan for failed login count. Acceptable for now - could optimize later with DB query.

---

## Deep Review Session 3: Auth & Security

**Files:** `server/api/auth.py`, `server/api/auth_async.py` (2 files, 857 LOC)

### [x] DR3-001: Admin Check DISABLED on /users Endpoint
**Priority:** HIGH | **File:** `server/api/auth_async.py:216-217`
**Issue:** `# TEMPORARILY DISABLED FOR DASHBOARD TESTING` - any authenticated user can list ALL users!
**Fixed:** Re-enabled `admin: dict = Depends(require_admin_async)`. Also added `order_by(User.user_id)`.

### [x] DR3-002: Duplicate Sync/Async Auth Endpoints
**Priority:** MEDIUM | **File:** `server/api/auth.py` + `server/api/auth_async.py`
**Issue:** Both files define same endpoints. Which is active? Both registered?
**Fixed:** Sync auth.py marked as DEPRECATED with warning on import. Async is primary.

### [x] DR3-003: Sync Auth Missing Audit Logging
**Priority:** MEDIUM | **File:** `server/api/auth.py`
**Issue:** Doesn't use `log_login_success`, `log_login_failure` - no audit trail.
**Fixed:** Added audit logging (log_login_success, log_login_failure) to sync auth.py.

### [x] DR3-004: list_users Without ORDER BY
**Priority:** MEDIUM | **File:** `server/api/auth.py:176`
**Issue:** `db.query(User).offset(skip).limit(limit)` - pagination without order.
**Fixed:** Added `.order_by(User.user_id)` for consistent pagination.

### [x] DR3-005: No Rate Limiting on Login
**Priority:** MEDIUM | **File:** `server/api/auth.py`, `server/api/auth_async.py`
**Issue:** Login endpoints have no rate limiting. Brute-force possible.
**Fixed:** Added rate limiting using `get_failed_login_count()` - max 5 attempts per IP per 15 min.

### [x] DR3-006: Hardcoded Role Validation
**Priority:** MEDIUM | **File:** `server/api/auth_async.py:422, 496`
**Issue:** `valid_roles = ["user", "admin"]` duplicated twice.
**Fixed:** Created `VALID_ROLES` constant at module level.

### [~] DR3-007: Sync Auth Missing Client IP
**Priority:** LOW | **File:** `server/api/auth.py`
**Accept:** Sync version doesn't extract client IP. Acceptable if deprecating sync.

### [~] DR3-008: No Password Complexity Validation
**Priority:** LOW | **File:** Both auth files
**Accept:** No min length/complexity rules. Acceptable for internal tool - admin controls user creation.

### [x] DR3-009: DEV_MODE for Claude Autonomous Testing
**Priority:** MEDIUM | **File:** `server/config.py`, `server/utils/dependencies.py`
**Issue:** No way for Claude to work autonomously without manual login. Commenting out auth is dangerous.
**Fixed:** Implemented DEV_MODE with all security constraints:
- `DEV_MODE=true` env flag (default: false)
- Localhost-only check (`127.0.0.1`, `::1`, `localhost`)
- PRODUCTION=true blocks DEV_MODE
- Startup warning logged
- Both sync and async auth functions support DEV_MODE
**Original spec:**

**Features needed:**
- `DEV_MODE=true` env flag (default: false)
- Auto-login: Skip auth, inject test user automatically
- Auto-admin: Full privileges for all endpoints
- Auto-API access: No token required for API calls
- Auto-session: Create session on first request
- Exe auto-login: Desktop app auto-authenticates on launch

**Security constraints (CRITICAL):**
- ONLY works when `request.client.host` is `127.0.0.1` or `localhost`
- NEVER works on non-localhost (even if DEV_MODE=true)
- Log warning on startup: "DEV_MODE enabled - localhost only"
- Reject if `PRODUCTION=true` is also set
- No DEV_MODE in compiled/distributed builds

**Implementation:**
```python
# In dependencies.py
async def get_current_user_dev_mode(request: Request):
    if config.DEV_MODE and is_localhost(request):
        return {"user_id": 1, "username": "dev_admin", "role": "admin"}
    # Normal auth flow...
```

---

## Deep Review Session 4: LDM Backend

**Files:** `server/tools/ldm/` (10 files, 4021 LOC)

### [ ] DR4-001: Sync DB Session in Async Endpoint
**Priority:** HIGH | **File:** `server/tools/ldm/api.py:867`
**Issue:** `next(get_db())` creates sync session inside async function. Blocks event loop.
**Impact:** At 100+ users, one slow query freezes entire server. Breaks scalability architecture.
**Fix:** Refactor TMManager to async, use `get_async_db()` dependency.

### [ ] DR4-002: Repeated Sync DB Pattern in TM Search
**Priority:** HIGH | **File:** `server/tools/ldm/api.py:969, 1003, 1028`
**Issue:** Multiple endpoints use `sync_db = next(get_db())` pattern.
**Impact:** Same as DR4-001. All TM search endpoints block event loop.
**Fix:** Part of DR4-001 fix - async TMManager.

### [ ] DR4-003: TM Suggest O(n) Similarity Loop
**Priority:** MEDIUM | **File:** `server/tools/ldm/api.py:781-804`
**Issue:** Fetches 1000 rows then Python loop for similarity. Slow for large TMs.
**Fix:** Use database FTS, trigram index, or FAISS search.

### [~] DR4-004: _semantic_search Returns Empty (TODO Stub)
**Priority:** MEDIUM | **File:** `server/tools/ldm/tm.py:132-140`
**Issue:** Method is TODO stub - always returns `[]`, falls back to text search.
**Accept:** Documented as intentional stub. Falls back to text search. Future FAISS integration planned.

### [ ] DR4-005: Full Backup Loads All Rows to Memory
**Priority:** MEDIUM | **File:** `server/tools/ldm/backup_service.py:251`
**Issue:** `db.query(LDMRow).all()` could OOM for large projects (100k+ rows).
**Fix:** Use chunked queries with yield/streaming.

### [~] DR4-006: Unused pandas Import
**Priority:** LOW | **File:** `server/tools/ldm/file_handlers/txt_handler.py:12`
**Accept:** `import pandas as pd` unused. Harmless but could remove.

### [~] DR4-007: Empty file_handlers/__init__.py
**Priority:** LOW | **File:** `server/tools/ldm/file_handlers/__init__.py`
**Accept:** Empty init file. Could add exports but not critical.

### [~] DR4-008: No Device Logging in TMIndexer
**Priority:** LOW | **File:** `server/tools/ldm/tm_indexer.py:132-133`
**Accept:** Doesn't log which device (CPU/GPU) is used. Minor.

---

## Deep Review Session 5: XLSTransfer

**Files:** `server/tools/xlstransfer/` (10 files, 3825 LOC)

### [x] DR5-001: excel_column_to_index Only Works for A-Z
**Priority:** MEDIUM | **File:** `server/tools/xlstransfer/core.py:80, 101`
**Issue:** `excel_column_to_index('AA')` returns wrong value. Only handles single letters.
**Fixed:** Updated both functions to support multi-letter columns (AA, AB, AZ, etc.).

### [x] DR5-002: Model Save Without Permission Check
**Priority:** MEDIUM | **File:** `server/tools/xlstransfer/embeddings.py:56-61`
**Issue:** `_model_instance.save(str(model_path))` after download could fail silently.
**Fixed:** Added try/except with warning log for OSError/PermissionError.

### [~] DR5-003: Duplicate clean_text vs normalize_text
**Priority:** MEDIUM | **File:** `server/tools/xlstransfer/core.py:22-55`
**Issue:** `clean_text()` here duplicates `normalize_text()` in `server/utils/text_utils.py`.
**Accept:** Different functions for different purposes. clean_text handles Excel-specific `_x000D_` removal with config. normalize_text handles Unicode/quote normalization for storage.

### [~] DR5-004: Type Hint Lowercase `any`
**Priority:** LOW | **File:** `server/tools/xlstransfer/translation.py:231`
**Accept:** `Dict[str, any]` should be `Dict[str, Any]`. Minor style issue.

### [~] DR5-005: Redundant Import in Config
**Priority:** LOW | **File:** `server/tools/xlstransfer/config.py:150-151`
**Accept:** Imports `Path` twice with different aliases. Harmless but messy.

---

## Deep Review Session 6: QuickSearch

**Files:** `server/tools/quicksearch/` (5 files, 1674 LOC)

### [x] DR6-001: Missing `import re` in parser.py
**Priority:** MEDIUM | **File:** `server/tools/quicksearch/parser.py:35`
**Issue:** `re.split()` used in `tokenize()` but `import re` is missing.
**Fixed:** Added `import re` at top of file.

### [x] DR6-002: etree Used Without HAS_LXML Guard
**Priority:** MEDIUM | **File:** `server/tools/quicksearch/qa_tools.py:107, 173, 348, 500, 667`
**Issue:** `HAS_LXML` flag defined but `etree.parse()` called without checking it first.
**Fixed:** Added HAS_LXML guard at all 5 locations. Logs warning and skips XML files if lxml not installed.

### [~] DR6-003: Hardcoded GAMES and LANGUAGES Lists
**Priority:** LOW | **File:** `server/tools/quicksearch/dictionary.py:18-19`
**Accept:** Hardcoded lists limit extensibility, but works for current use case.

### [~] DR6-004: Nested Functions in search_one_line
**Priority:** LOW | **File:** `server/tools/quicksearch/searcher.py:118-131`
**Accept:** `check_match()` and `is_valid_entry()` defined inside method. Could be module-level but harmless.

---

## Deep Review Session 7: KR Similar

**Files:** `server/tools/kr_similar/` (4 files, 1064 LOC)

### [x] DR7-001: Bare Except Clauses
**Priority:** MEDIUM | **File:** `server/tools/kr_similar/embeddings.py:401, 408`
**Issue:** `except:` without specific exception type. Could hide real errors.
**Fixed:** Changed to `except Exception:` at both locations.

### [~] DR7-002: Hardcoded DICT_TYPES List
**Priority:** LOW | **File:** `server/tools/kr_similar/embeddings.py:32`
**Accept:** Same pattern as QuickSearch. Works for current use case.

### [~] DR7-003: Uses '\\n' Literal for Line Splits
**Priority:** LOW | **File:** `server/tools/kr_similar/core.py:30, 165`
**Accept:** Intentional - language files use literal `\n` (backslash-n) as separators.

---

## Deep Review Session 8: API Layer

**Files:** `server/api/` (18 files, 9583 LOC) - Sampled key files

### [ ] DR8-001: 13 Admin Endpoints With Auth Disabled (stats.py)
**Priority:** HIGH | **File:** `server/api/stats.py` (multiple lines)
**Issue:** Same pattern as DR3-001 - `# TEMPORARILY DISABLED FOR DASHBOARD TESTING`:
- Lines: 32, 110, 180, 252, 327, 402, 488, 562, 633, 698, 1043, 1137, 1261
- Affects: overview, daily, weekly, monthly stats, tool popularity, function stats, performance, errors, logs, database, server
**Impact:** Security gap - any user can access admin stats without authentication.
**Fix:** Re-enable `admin: dict = Depends(require_admin)`. DEV_MODE handles localhost testing.

### [ ] DR8-002: base_tool_api Creates New Engine Per Sync Call
**Priority:** HIGH | **File:** `server/api/base_tool_api.py:256, 321`
**Issue:** `create_engine()` called in sync methods creates new connections instead of using pool.
**Impact:** At 100+ concurrent users, connection pool exhausted, new connections created per request.
**Fix:** Use shared engine from `db_setup.py` or pass session from dependency injection.

### [~] DR8-003: stderr Redirect in Background Tasks
**Priority:** LOW | **File:** `server/api/base_tool_api.py:557`
**Accept:** `sys.stderr = open(os.devnull, 'w')` suppresses errors in background. Intentional to avoid broken pipe errors.

---

## Deep Review Session 9: Frontend Core

**Files:** `locaNext/src/` (31 files, Svelte + JS)

### [~] DR9-001: console.log Statements in Production
**Priority:** LOW | **File:** Multiple (client.js, websocket.js, etc.)
**Accept:** Already noted in Quick Scan (ISS-005). Frontend polish - deferred.

### [~] DR9-002: No TypeScript
**Priority:** LOW | **File:** All .js files
**Accept:** JavaScript instead of TypeScript. Works fine, optional enhancement.

**Positive Findings:**
- Clean API client with proper token management
- WebSocket service with reconnection handling
- Proper error handling in fetch calls
- 401 handling clears auth automatically

---

## Deep Review Session 10: Frontend LDM

**Files:** `locaNext/src/lib/components/ldm/` (4 files, ~2400 LOC)

### [x] DR10-001: Hardcoded API_BASE in VirtualGrid
**Priority:** MEDIUM | **File:** `locaNext/src/lib/components/ldm/VirtualGrid.svelte:20`
**Issue:** `const API_BASE = 'http://localhost:8888'` hardcoded instead of using serverUrl store.
**Fixed:** Now imports serverUrl from stores and uses `get(serverUrl)`.

### [x] DR10-002: Hardcoded API_BASE in DataGrid
**Priority:** MEDIUM | **File:** `locaNext/src/lib/components/ldm/DataGrid.svelte:25`
**Issue:** Same hardcoded URL pattern.
**Fixed:** Now imports serverUrl from stores and uses `get(serverUrl)`.

### [~] DR10-003: Row Locking Disabled (Known Issue)
**Priority:** LOW | **File:** `locaNext/src/lib/components/ldm/VirtualGrid.svelte:314`
**Accept:** Documented in ISSUES_TO_FIX.md - WebSocket event delivery issue.

**Positive Findings:**
- Clean virtual scrolling implementation
- Real-time WebSocket updates working
- Good Carbon Design System integration
- TM suggestions panel well-designed

---

## Deep Review Session 11: Admin Dashboard

**Files:** `adminDashboard/src/` (17 files, Svelte + JS)

### [x] DR11-001: Hardcoded API_BASE_URL
**Priority:** MEDIUM | **File:** `adminDashboard/src/lib/api/client.js:6`
**Issue:** `const API_BASE_URL = 'http://localhost:8888/api/v2'` hardcoded.
**Fixed:** Now uses `import.meta.env.VITE_API_URL` with localhost fallback.

### [~] DR11-002: console.log in API Error Handler
**Priority:** LOW | **File:** `adminDashboard/src/lib/api/client.js:61`
**Accept:** `console.error('API Request failed:', error)` for debugging. Fine for admin tool.

**Positive Findings:**
- Clean API client with comprehensive endpoints
- Good admin-specific separation from main app
- Proper token handling (uses 'admin_token' key)

---

## Deep Review Session 12: Scripts & Config

**Files:** `scripts/` (20+ files, bash + python)

### [~] DR12-001: Hardcoded Paths in Shell Scripts
**Priority:** LOW | **File:** `scripts/start_all_servers.sh:19-20`
**Accept:** `PROJECT_DIR="/home/neil1988/LocalizationTools"` hardcoded. Standard for deployment scripts.

### [~] DR12-002: Default Admin Password in Logs
**Priority:** LOW | **File:** `scripts/create_admin.py:124`
**Accept:** Prints default password to console. Acceptable for initial setup - warns to change.

**Positive Findings:**
- Well-documented shell scripts with clear headers
- Proper error handling with `set -e`
- nohup+disown pattern for persistent servers
- Health check loops for service readiness
- Python scripts use loguru properly

---

## Summary

| Source | Total | Open | Fixed | Accept | Defer |
|--------|-------|------|-------|--------|-------|
| Quick Scan | 9 | 0 | 4 | 4 | 1 |
| Session 1 | 8 | 0 | 5 | 3 | 0 |
| Session 2 | 8 | 0 | 5 | 3 | 0 |
| Session 3 | 9 | 0 | 7 | 2 | 0 |
| Session 4 | 8 | 4 | 0 | 4 | 0 |
| Session 5 | 5 | 0 | 2 | 3 | 0 |
| Session 6 | 4 | 0 | 2 | 2 | 0 |
| Session 7 | 3 | 0 | 1 | 2 | 0 |
| Session 8 | 3 | 2 | 0 | 1 | 0 |
| Session 9 | 2 | 0 | 0 | 2 | 0 |
| Session 10 | 3 | 0 | 2 | 1 | 0 |
| Session 11 | 2 | 0 | 1 | 1 | 0 |
| Session 12 | 2 | 0 | 0 | 2 | 0 |
| **TOTAL** | **66** | **6** | **29** | **30** | **1** |

**Phase 3 Status:**
- âœ… Group A: Hardcoded URLs (3 fixed)
- âœ… Group B: Database/SQL (5 fixed + migration script)
- âœ… Group C: Async/Sync (3 fixed, 2 accept)
- âœ… Group D: Auth Refactor (5 fixed)
- âœ… Group E: Code Bugs (8 fixed, 2 accept)
- âœ… Group G: DEV_MODE (1 fixed)
- ðŸ”¨ **Group H: Scale Issues (6 OPEN - IN PROGRESS)**
  - DR4-001/002: Async TMManager (blocks event loop)
  - DR4-003: TM O(n) search (slow at scale)
  - DR4-005: Backup memory (OOM at 50M rows)
  - DR8-001: Auth disabled (security gap)
  - DR8-002: Engine per call (connection exhaustion)

---

## When Complete

1. All issues marked [x], [~], or [-]
2. Move this file to `history/ISSUES_20251212.md`
3. Create new issue list for next review cycle

---

*Last Updated: 2025-12-12*
